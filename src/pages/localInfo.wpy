<style lang="less">
page{
  background-color: #f7f7f7;
}
.price,
.localName,
.label,
.rule,
.localInfo,
.reportData,
.houseType,
.feature{
  background-color: #fff;
}
.banner{
  width: 100vw;
  height: 440rpx;
}
.price{
  width: 670rpx;
  padding: 40rpx;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.price text{
  font-size: 40rpx;
  color: #7bb312;
  font-weight: 600;
}
.price view{
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction:column;
  color: #fa5454;
  font-size: 34rpx !important;
}
.price view view{
  font-size: 20rpx !important;
}
.localName{
  width: 670rpx;
  padding: 0 40rpx;
  font-size: 38rpx;
  color: #343434;
  font-weight: 600;
}
.label{
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 670rpx;
  padding: 30rpx 40rpx;
}
.label view:nth-child(1){
  font-size: 20rpx;
  color: #9e9e9e;
  background-color: #f2f2f2;
  padding: 10rpx 20rpx;
}
.label view:nth-child(2),
.label icon{
  font-size: 30rpx !important;
  font-weight: 600;
  color: #343434;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}


.localInfo{
  width: 670rpx;
  height: auto;
  padding: 35rpx 40rpx;
  margin-top: 20rpx;
}
.localInfo .localitem{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10rpx 0;
}
.localInfo .localitem view:nth-child(1){
  width: 160rpx;
  font-size: 27rpx;
  color: #979797;
}
.localInfo .localitem view:nth-child(2){
  width: 480rpx;
  font-size: 27rpx;
  color: #343434;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.localInfo .localitem view:nth-child(3){
  width: 30rpx;
}
.localInfo .localitem icon{
  width: 30rpx !important;
  font-size: 27rpx;
  color: #979797;
}
.rule{
  width: 670rpx;
  padding: 40rpx;
  margin-top: 20rpx;
}
.ruleList{
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.ruleList text{
  font-size: 35rpx;
  color: #343434;
  font-weight: 600;
}
.ruleList view,
.ruleList icon{
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 27rpx !important;
  color: #979797;
}
.rule .description{
  font-size: 28rpx;
  color: #343434;
  font-weight: 600;
  margin-top: 15rpx;
  padding: 44rpx 0;
}
.reportData{
  width: 750rpx;
  height: 150rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #fff;
  border-top: 1rpx solid #f2f2f2;
}
.reportDataBorder{
  width: 0rpx;
  height: 45rpx;
  border:1px solid #c6c6c6;
}
.dataCon{
  width: 374rpx;
  height: 150rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction:column;
}
.dataCon view:nth-child(2){
  font-size: 35rpx;
  color: #333;
  font-weight: 600;
}
.dataCon view:nth-child(1){
  font-size: 25rpx;
  color: #979797;
}
.houseType{
  width: 670rpx;
  padding: 40rpx;
  white-space: nowrap;
  overflow:hidden;
}
.houseTypeItem{
  display: inline-block;
  width: 260rpx;
  margin-right: 30rpx;
}
.houseTypeItem image{
  width: 260rpx;
  height: 150rpx;
  border-radius: 20rpx;
}

.houseTypeItem view{
  padding: 5rpx 0;
}
.houseTypeItem view:nth-child(2){
  font-size: 30rpx;
  color: #343434;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.houseTypeItem view:nth-child(3){
  font-size: 20rpx;
  color: #979797;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.houseTypeItem view:nth-child(4){
  font-size: 25rpx;
  color: #7bb312;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.feature{
  width: 670rpx;
  padding: 40rpx;
}
.featureItem{
  display: flex;
  justify-content: space-between;
  border-bottom: 1rpx solid #f0f0f0;
  padding: 20rpx 0;
}
.featureItem view:nth-child(1){
  width: 170rpx;
  font-size: 30rpx;
  color: #979797;
}
.featureItem view:nth-child(2){
  width: 500rpx;
  font-size: 30rpx;
  color: #343434;
  line-height: 50rpx;
}
.nav{
  position: fixed;
  bottom: 0;
  background-color: #fff;
  width: 750rpx;
  height: 150rpx;
  display: flex;
  align-items: center;
  justify-content: space-around;
}
.nav view:nth-child(2),
.nav view:nth-child(3){
  width: 248rpx;
  height: 95rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30rpx;
  border-radius: 20rpx;
}
.nav view:nth-child(1){
  width: 95rpx;
  height: 95rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  font-size: 20rpx;
  color: #343434;
}
.nav view:nth-child(1) icon{
  font-size: 40rpx !important;
  color: #343434;
}
.nav view:nth-child(2){
  background-color: #f5ffe1;
  color: #7bb312;
}
.nav view:nth-child(3){
  background-color: #7bb312;
  color: #fff;
}
.marginNav{
  margin-bottom: 170rpx;
}
.mobile{
  width:640rpx;
  background-color:#fff;
  padding:30rpx 0;
  border-radius:20rpx;
}
.selMobile{
  width:580rpx;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:20rpx 30rpx;
  font-size: 27rpx;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.mobileClose{
  width: 200rpx;
  height: 80rpx;
  border-radius: 20rpx;
  background-color: #7bb312;
  margin: 20rpx auto;
  color: #fff;
  font-size: 30rpx;
  display:flex;
  align-items:center;
  justify-content:center;
}
button{
  width: 100%;
  height: 100%;
  background-color: #f5ffe1;
  color:#7bb312;
}
.brokerage{
  color: #fa5454 !important;
  font-size: 40rpx !important;
}
.brokerage2{
  color: #7bb312 !important;
}
</style>
<template>
  <view>
    <swiper class='banner' indicator-dots="true" autoplay='true' interval='5000' duration='2000'>
      <repeat for="{{localList.img}}" item="item">
        <swiper-item>
          <image class="banner" src="{{ requestImgUrl + item }}" />
        </swiper-item>
      </repeat>
    </swiper>
    <view class="price">
      <text>{{localList.money}}</text>
      <view>
        <!-- 实心  shoucang -->
        <!-- 空心  shoucang1 -->
        <icon class="iconfont {{localList.is_collect == 1?'icon-shoucang':'icon-shoucang1'}}" @tap="collection"></icon>
        <view wx:if="{{localList.is_collect == 1}}">已收藏</view>
        <view wx:if="{{localList.is_collect == 0}}">收藏</view>
      </view>
    </view>
    <view class="localName">{{localList.name}}</view>
    <view class="label">
      <view>开发商:{{localList.developer}}</view>
      <view @tap="goLocalMoreInfo">
        更多信息
        <icon class="iconfont icon-jiantou-you"></icon>
      </view>
    </view>
    <view class="rule" wx:if="{{userInfo.store != '' && userInfo.store != undefined && userInfo.store != null }}">
      <view class="ruleList">
        <text>佣金</text>
        <view></view>
      </view>
      <view class="description brokerage">{{localList.brokerage}}</view>
    </view>
    <view class="localInfo">
      <view class="localitem">
        <view>开盘时间</view>
        <view>{{localList.opening_time}}</view>
        <view></view>
      </view>
      <view class="localitem">
        <view>合作周期</view>
        <view>{{localList.cooperate_time}}</view>
        <view></view>
      </view>
      <view class="localitem" @tap="showAddress">
        <view>楼盘地址</view>
        <view>{{localList.floor_address}}</view>
        <view>
          <icon class="iconfont icon-jiantou-you"></icon>
        </view>
      </view>
    </view>
    <view class="rule">
      <view class="ruleList">
        <text>导客规则</text>
        <view @tap="goRuleInfo">
          查看全部
          <icon class="iconfont icon-jiantou-you"></icon>
        </view>
      </view>
      <view class="description brokerage2">{{localList.reporting_rule}}</view>
    </view>
    <view class="reportData">
      <view class="dataCon" @tap="goReportList">
        <view>报备有效期</view>
        <view>{{localList.effective}}</view>
      </view>
      <view class="reportDataBorder"></view>
      <view class="dataCon" @tap="goCollectionList">
        <view>带看保护期</view>
        <view>{{localList.guard}}</view>
      </view>
    </view>
    <view class="localName">户型</view>
    <scroll-view scroll-x="true" class="houseType">
      <repeat for="{{localList.hx}}" item="item">
        <view class="houseTypeItem" data-id="{{item.id}}">
          <image class="banner" src="{{requestImgUrl + item.model_img}}" bindtap='shareQRCodeImg' data-imgurl="{{requestImgUrl + item.model_img}}" />
          <view>{{item.model_name}}</view>
          <view>{{item.model_mi}}</view>
          <view>{{item.model_money}}</view>
        </view>
      </repeat>
    </scroll-view>
    <view class="localName">{{localList.name}}</view>
    <view class="feature">
      <view class="featureItem">
        <view class="featureName">交通配套</view>
        <view class="featureCon">{{localList.traffic}}</view>
      </view>
      <view class="featureItem">
        <view class="featureName">教育资源</view>
        <view class="featureCon">{{localList.education}}</view>
      </view>
      <view class="featureItem">
        <view class="featureName">医疗健康</view>
        <view class="featureCon">{{localList.medical}}</view>
      </view>
      <view class="featureItem">
        <view class="featureName">商场购物</view>
        <view class="featureCon">{{localList.shopping}}</view>
      </view>
      <view class="featureItem">
        <view class="featureName">生活娱乐</view>
        <view class="featureCon">{{localList.recreation}}</view>
      </view>
    </view>
    <view class="localName">推荐楼盘</view>
    <scroll-view scroll-x="true" class="houseType marginNav">
      <repeat for="{{propertyLocalList}}" item="item">
        <view class="houseTypeItem" data-id="{{item.id}}" @tap="updataLocal">
          <image class="banner" src="{{requestImgUrl + item.img}}" />
          <view>{{item.name}}</view>
          <view>{{item.money}}</view>
        </view>
      </repeat>
    </scroll-view>
    <view class="nav">
      <view @tap="mobileShow">
        <icon class="iconfont icon-dianhua"></icon>
        <text>联系项目</text>
      </view>
      <view wx:if="{{share == 0}}">
        <button open-type='share'>分享</button>
      </view>
      <view wx:if="{{share == 1}}" @tap="goHome">返回首页</view>
      <!-- <view>分享楼盘</view> -->
      <view @tap="goReportUser">报备客户</view>
    </view>
    <view class="mask" wx:if="{{selMobileShow}}">
      <view class="mobile">
        <view class="selMobile" data-phone="{{localList.mobile}}" @tap="tel">项目经理{{localList.contact}}：{{localList.mobile}}</view>
        <view class="selMobile" data-phone="{{localList.resident_mobile}}" @tap="tel">项目驻场{{localList.resident_name}}：{{localList.resident_mobile}}</view>
        <view class="mobileClose" @tap="mobileShow">关闭</view>
      </view>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  export default class LocalInfo extends wepy.page {
    config = {
      navigationBarTitleText: '项目详情'
    }
    components = {

    }

    mixins = []

    data = {
      img: '/img/test.jpg',
      test: '',
      propertyLocalList: [],
      cityNode: {},
      userInfo: {},
      share: 1,
      requestImgUrl: '',
      selMobileShow: false,
      localList: []
    }

    computed = {

    }

    methods = {
      goHome() {
        this.$redirect('loginRegistered')
      },
      // 点击图片放大，长按后可操作
      shareQRCodeImg(e) {
        let url =  e.currentTarget.dataset.imgurl
        wx.previewImage({
          current: [url], // 当前显示图片的http链接   
          urls: [url] // 需要预览的图片http链接列表   
        })
      },
      updataLocal(e) {
        // 根据点击的楼盘切换到当前页的数据
        // e.currentTarget.dataset.id
        this.id = e.currentTarget.dataset.id
        this.getFoodList()
        wx.pageScrollTo({
          scrollTop: 0
        })
      },
      tel(e) {
        // 拨打电话
        wx.makePhoneCall({
          phoneNumber: e.currentTarget.dataset.phone,
        })
      },
      showAddress() {
        // 显示楼盘地址导航，地图
        
        wx.getLocation({
          type: 'gcj02', //返回可以用于wx.openLocation的经纬度
          success: function(res) {
            var latitude = res.latitude
            var longitude = res.longitude
            wx.openLocation({
              latitude: 33.42,
              longitude: 107.40,
              name: '艾泽拉斯',
              address: '艾泽拉斯艾泽拉斯艾泽拉斯',
              scale: 28
            })
          }
        })
      },
      collection() {
        if (this.userInfo.mobile == '') {
          wx.showModal({
            title: '',
            content: '请先注册'
          })
          this.$redirect('loginRegistered')
          return ''
        }
        // 收藏或取消收藏
        let typeData = 0
        if (this.localList.is_collect == 0) {
          typeData = 1
        } else {
          typeData = 0
        }
        this.collectionRun(typeData)
      },
      mobileShow() {
        // 显示联系方式
        if (this.selMobileShow) {
          this.selMobileShow = false
        } else {
          this.selMobileShow = true
        }
      },
      goReportUser(e) {
        if (this.userInfo.mobile == '') {
          wx.showModal({
            title: '',
            content: '请先注册'
          })
          this.$redirect('loginRegistered')
          return ''
        }
        // 进入报备用户页
        this.$navigate(`/pages/reportLocal?id=${e.currentTarget.dataset.id}`)
      },
      goLocalMoreInfo(e) {
        // 产看楼盘的更多信息
        // jfsj 交房时间
        // cqnx 产权年限
        // wygs 物业公司
        // kfs 开发商
        // kfspp 开发商品牌
        // jzmj 建筑面积
        // rjl 容积率
        // lhl 绿化率
        // zhs 总户数
        // cws 车位数
        // cwb 车位比
        // jj 均价
        // dfl 得房率
        // wyf 物业费
        // wylx 物业类型
        // jzlx 建筑类型
        // zxzk 装修状况
        let setData = this.localList
        let urldata = `jfsj=${setData.delivery_time}&cqnx=${setData.years_limit}&wygs=${setData.property}&kfs=${setData.developer}&kfspp=${setData.brand_developer}&jzmj=${setData.construction_area}&rjl=${setData.volume_rate}&lhl=${setData.green_rate}&zhs=${setData.total_houses}&cws=${setData.car_number}&cwb=${setData.car_scale}&jj=${setData.average_price}&dfl=${setData.room_rate}&wyf=${setData.property_costs}&wylx=${setData.property_type}&jzlx=${setData.building_type}&zxzk=${setData.decoration_status}`
        this.$navigate(`/pages/localMoreInfo?${urldata}`)
      },
      goRuleInfo(e) {
        // 进入预约列表
        // bbgz 报备规则
        // bbgzcon 报备规则内容
        // dkgz 带看规则
        // dkgzcon 带看规则内容
        // jygz 结佣规则
        // jygzcon 结佣规则内容
        // spzd 售盘知道
        // spzdcon 售盘知道内容
        let setData = this.localList
        let urldata = `bbgz=${setData.reporting_rule}&bbgzcon=${setData.reporting_rule_count}&dkgz=${setData.look_rule}&dkgzcon=${setData.look_rule_count}&jygz=${setData.set_up_rule}&jygzcon=${setData.set_up_rule_count}&spzd=${setData.sale_know}&spzdcon=${setData.sale_know_count}`
        this.$navigate(`/pages/ruleInfo?${urldata}`)
      }
    }

    events = {

    }

    onLoad(options) {
      this.id = options.id
      this.share = options.share
      this.userInfo = this.$parent.globalData.userInfo
      this.requestImgUrl = this.$parent.globalData.requestImgUrl
      this.cityNode = this.$parent.globalData.cityNode
      this.getFoodList()
      // 推荐的楼盘
      this.getLocalList()
    }
    onShareAppMessage() {
      let url = `pages/localInfo?id=${this.localList.id}&share=1`
      return {
        title: this.localList.name,
        desc: this.localList.floor_address,
        imageUrl: this.requestImgUrl + this.localList.img[0],
        path: url
      }
    }
    getFoodList() {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/floor`,
        method: 'POST',
        data: {
          id: this.id,
          uid: this.userInfo.id
        },
        success: data => {
          if (data.data.code == 1) {
            let localListData = this.$parent.null2str(data.data.data)
            let imgList = [localListData.img]
            let i = 0
            for (i in localListData.xq_img) {
              imgList.push(localListData.xq_img[i].img)
            }
            localListData['img'] = imgList
            this.localList = localListData
            // this.localList.cooperate_time = this.$parent.getLocalTime(this.localList.cooperate_time)
            // this.localList.opening_time = this.$parent.getLocalTime(this.localList.opening_time)
            this.$apply()
          } else {
            wx.showModal({
              title: '',
              content: data.data.msg
            })
          }
        }
      })
    }
    getLocalList() {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/local_floor`,
        method: 'POST',
        data: {
          city_id: this.cityNode.id
        },
        success: data => {
          if (data.data.code == 1) {
            this.propertyLocalList = this.$parent.null2str(data.data.data)
            this.$apply()
          } else {
            wx.showModal({
              title: '',
              content: data.data.msg
            })
          }
        }
      })
    }
    collectionRun(typeData) {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/floor_keep`,
        method: 'POST',
        data: {
          uid: this.userInfo.id,
          floor_id:this.localList.id,
          type: typeData
        },
        success: data => {
          if (data.data.code == 1) {
            this.getFoodList()
            this.$apply()
          } else {
            wx.showModal({
              title: '',
              content: data.data.msg
            })
          }
        }
      })
    }
  }
</script>